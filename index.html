<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAN Node Controller Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #212121; --header-bg: #2B2B2B; --card-bg: #1A1A1A;
            --accent-blue: #1f538d; --accent-green: #2ecc71; --accent-red: #a93226; --text-color: #ffffff;
            --border: #3E3E3E;
        }

        body { background-color: var(--bg-color); color: var(--text-color); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;}
        header { background-color: var(--header-bg); padding: 10px 20px; display: flex; gap: 15px; align-items: center; border-bottom: 1px solid var(--border); }
        
        .btn { background-color: var(--accent-blue); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background 0.2s; font-size: 0.85em; }
        .btn-send { background-color: #e67e22; }
        .btn-disconnect { background-color: var(--accent-red); }
        .btn-refresh-small { background-color: #444; padding: 4px 10px; font-size: 0.7em; margin-top: 8px; border: 1px solid #555; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-refresh-small:hover { background-color: #555; }

        input, select { background: #333; color: white; border: 1px solid var(--border); padding: 5px; border-radius: 4px; }
        .preview-box { font-family: monospace; background: #000; padding: 5px 10px; border-radius: 4px; color: #aaa; border: 1px solid #444; min-width: 150px; font-size: 0.85em; }

        main { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; flex: 1; overflow: hidden; }
        .scroll-container { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
        
        .scroll-header { padding: 12px; background: var(--header-bg); text-align: center; border-bottom: 1px solid var(--border); }
        .header-main { font-weight: bold; color: #5dade2; display: block; font-size: 1.1em; text-transform: uppercase; }
        .header-sub { font-size: 0.75em; color: #888; display: block; margin-top: 2px; }

        .scroll-content { flex: 1; overflow-y: auto; padding: 10px; }
        .data-row { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #333; font-family: monospace; gap: 10px; font-size: 0.9em; user-select: none; }
        .data-row:hover { background: #252525; cursor: pointer; }
        .data-label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .data-value { color: var(--accent-green); width: 140px; text-align: right; font-weight: bold; }

        #graph-area { grid-column: span 2; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; height: 450px; padding: 15px; position: relative; }
        .graph-controls { position: absolute; top: 15px; right: 20px; z-index: 10; display: flex; align-items: center; gap: 15px; font-size: 0.85em; background: rgba(0,0,0,0.6); padding: 6px 12px; border-radius: 6px; border: 1px solid #444; }
    </style>
</head>
<body>

<header>
    <button id="connectBtn" class="btn">Connect Serial</button>
    <div style="border-left: 1px solid #444; padding-left: 15px;">
        <span style="color:#888; font-size:0.8em;">TARGET NODE</span>
        <input type="number" id="nodeIdSelect" value="1" min="1" max="31" style="width: 45px;">
    </div>
    <div style="border-left: 1px solid #444; padding-left: 15px; display: flex; gap: 10px; align-items: center;">
        <select id="cmdType"></select>
        <input type="text" id="cmdValue" placeholder="Value" style="width: 80px;">
        <div class="preview-box" id="previewStr">-- -- ----------------</div>
        <button id="sendBtn" class="btn btn-send">Send</button>
    </div>
</header>

<main>
    <div class="scroll-container">
        <div class="scroll-header">
            <span class="header-main">DEVICE SETTINGS (NODE <span id="setNodeLabel">1</span>)</span>
            <button id="refreshRtr" class="btn btn-refresh-small">Refresh All</button>
        </div>
        <div id="config-list" class="scroll-content"></div>
    </div>

    <div class="scroll-container">
        <div class="scroll-header">
            <span class="header-main">LIVE TELEMETRY (NODE <span id="teleNodeLabel">1</span>)</span>
            <span class="header-sub">(Select to Graph)</span>
        </div>
        <div id="telemetry-list" class="scroll-content"></div>
    </div>

    <div id="graph-area">
        <div class="graph-controls">
            <label style="display: flex; align-items: center; gap: 8px; color: #ffffff; font-weight: bold; cursor: pointer;">
                <input type="checkbox" id="freezeToggle"> FREEZE
            </label>
            <div style="border-left: 1px solid #555; height: 15px; margin: 0 5px;"></div>
            <div>
                <span>TIME BASE:</span>
                <select id="timeBaseSelect">
                    <option value="10">10s</option>
                    <option value="30" selected>30s</option>
                    <option value="60">1m</option>
                    <option value="300">5m</option>
                </select>
            </div>
        </div>
        <canvas id="telemetryChart"></canvas>
    </div>
</main>

<script>
    const CAN_FORMATS = {
        0: ["NOP", null], 1: ["Set Position (deg)", 'Float64'], 2: ["Set Position (steps)", 'BigInt64'],
        3: ["Set Velocity (deg/s)", 'Float32'], 5: ["Enable (0/1)", 'Uint8'], 
        19: ["Report Freq (Hz)", 'Special19'], 25: ["Set Node ID", 'Uint16']
    };

    const TELEMETRY_FIELDS = {
        32: ["Encoder Counts", 'BigInt64'], 33: ["Encoder Angle (deg)", 'Float64'],
        34: ["Voltage", 'Float32'], 38: ["Board Temp (Â°C)", 'Float32'], 42: ["Current Vel (deg/s)", 'Float32']
    };

    let port, reader;
    let keepReading = true;
    let isFrozen = false;
    const activePlots = new Set();
    let timeWindowSeconds = 30;
    const startTime = Date.now();

    function initUI() {
        const cfg = document.getElementById('config-list');
        const tel = document.getElementById('telemetry-list');
        const cmd = document.getElementById('cmdType');

        Object.entries(CAN_FORMATS).forEach(([id, info]) => {
            cfg.innerHTML += `
                <div class="data-row">
                    <span class="data-label">[${id}] ${info[0]}</span>
                    <span class="data-value" id="val-${id}">---</span>
                </div>`;
            cmd.innerHTML += `<option value="${id}">${id}: ${info[0]}</option>`;
        });

        Object.entries(TELEMETRY_FIELDS).forEach(([id, info]) => {
            tel.innerHTML += `
                <div class="data-row">
                    <input type="checkbox" class="plot-trigger" data-mid="${id}">
                    <span class="data-label">[${id}] ${info[0]}</span>
                    <span class="data-value" id="val-${id}">---</span>
                </div>`;
        });
        
        document.querySelectorAll('.data-row').forEach(row => {
            row.addEventListener('dblclick', () => {
                const label = row.querySelector('.data-label').innerText;
                const match = label.match(/\[(\d+)\]/);
                if (match) requestRtr(match[1]);
            });
        });
        updatePreview();
    }
    initUI();

    function syncNodeUI() {
        const node = document.getElementById('nodeIdSelect').value;
        document.getElementById('setNodeLabel').innerText = node;
        document.getElementById('teleNodeLabel').innerText = node;
        document.querySelectorAll('.data-value').forEach(el => el.innerText = "---");
        document.querySelectorAll('.plot-trigger').forEach(cb => {
            cb.checked = activePlots.has(`${node}-${cb.dataset.mid}`);
        });
        updatePreview();
    }
    document.getElementById('nodeIdSelect').addEventListener('input', syncNodeUI);
    document.getElementById('freezeToggle').addEventListener('change', (e) => isFrozen = e.target.checked);

    const ctx = document.getElementById('telemetryChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: { datasets: [] },
        options: {
            responsive: true, maintainAspectRatio: false, animation: false,
            interaction: { mode: 'nearest', intersect: false },
            scales: {
                x: { 
                    type: 'linear', position: 'bottom', grid: { color: '#333' }, 
                    ticks: { color: '#888' },
                    title: { display: true, text: 'Seconds Since Start', color: '#888' }
                },
                y: { grid: { color: '#333' }, ticks: { color: '#888' } }
            },
            plugins: { 
                legend: { labels: { color: '#fff', boxWidth: 12 } },
                tooltip: { enabled: true }
            }
        }
    });

    document.getElementById('timeBaseSelect').addEventListener('change', (e) => timeWindowSeconds = parseInt(e.target.value));

    document.addEventListener('change', (e) => {
        if (e.target.classList.contains('plot-trigger')) {
            const node = document.getElementById('nodeIdSelect').value;
            const mid = e.target.dataset.mid;
            const key = `${node}-${mid}`;
            if (e.target.checked) {
                activePlots.add(key);
                const color = `hsl(${Math.random() * 360}, 70%, 60%)`;
                chart.data.datasets.push({
                    label: `N${node}: ${TELEMETRY_FIELDS[mid][0]}`,
                    data: [], borderColor: color,
                    borderWidth: 1.5,
                    pointRadius: 1,
                    pointHoverRadius: 6,
                    pointBackgroundColor: color,
                    tension: 0.4,
                    key: key
                });
            } else {
                activePlots.delete(key);
                chart.data.datasets = chart.data.datasets.filter(ds => ds.key !== key);
            }
            chart.update();
        }
    });

    function parseLine(line) {
        const parts = line.split(" ");
        if (parts.length < 3) return;
        const fid = parseInt(parts[0], 16), nid = fid >> 6, mid = fid & 0x3F;
        const config = CAN_FORMATS[mid] || TELEMETRY_FIELDS[mid];
        if (!config) return;

        try {
            const bytes = new Uint8Array(parts[2].match(/.{1,2}/g).map(b => parseInt(b, 16)));
            const view = new DataView(bytes.buffer);
            let val, displayVal;

            if (config[1] === 'Special19') {
                const freqA = view.getUint16(0, true), freqO = view.getUint16(2, true);
                val = freqA; displayVal = `A:${freqA} | O:${freqO}`;
            } else {
                switch(config[1]) {
                    case 'Float64': val = view.getFloat64(0, true); break;
                    case 'Float32': val = view.getFloat32(0, true); break;
                    case 'Uint16': val = view.getUint16(0, true); break;
                    case 'Uint8': val = view.getUint8(0); break;
                    case 'BigInt64': val = Number(view.getBigInt64(0, true)); break;
                }
                displayVal = typeof val === 'number' ? val.toFixed(2) : val;
            }

            if (nid == document.getElementById('nodeIdSelect').value) {
                const el = document.getElementById(`val-${mid}`);
                if (el) el.innerText = displayVal;
            }

            const ds = chart.data.datasets.find(d => d.key === `${nid}-${mid}`);
            if (ds) {
                const currentTime = (Date.now() - startTime) / 1000;
                ds.data.push({ x: currentTime, y: val });
                
                const cutoff = currentTime - timeWindowSeconds;
                ds.data = ds.data.filter(p => p.x > (cutoff - 2)); 
                
                if (!isFrozen) {
                    chart.options.scales.x.min = cutoff;
                    chart.options.scales.x.max = currentTime;
                    chart.update('none');
                }
            }
        } catch(e) {}
    }

    const connectBtn = document.getElementById('connectBtn');
    connectBtn.addEventListener('click', async () => {
        if (port) {
            keepReading = false;
            if (reader) await reader.cancel();
            await port.close(); port = null;
            connectBtn.innerText = "Connect Serial";
            connectBtn.classList.remove('btn-disconnect');
            return;
        }
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        keepReading = true;
        connectBtn.innerText = "Disconnect";
        connectBtn.classList.add('btn-disconnect');
        const textDecoder = new TextDecoderStream();
        port.readable.pipeTo(textDecoder.writable);
        reader = textDecoder.readable.getReader();
        let buffer = "";
        while (keepReading) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += value;
            let lines = buffer.split("\n");
            buffer = lines.pop();
            lines.forEach(l => parseLine(l.trim()));
        }
    });

    function constructPayload(mid, valStr) {
        const type = CAN_FORMATS[mid][1];
        const buffer = new ArrayBuffer(8);
        const view = new DataView(buffer);
        const val = parseFloat(valStr) || 0;
        try {
            if (type === 'Float64') view.setFloat64(0, val, true);
            else if (type === 'Float32') view.setFloat32(0, val, true);
            else if (type === 'Uint16') view.setUint16(0, val, true);
            else if (type === 'Uint8') view.setUint8(0, val);
            else if (type === 'BigInt64') view.setBigInt64(0, BigInt(Math.floor(val)), true);
            else if (type === 'Special19') {
                const p = valStr.split(',');
                view.setUint16(0, parseInt(p[0]||0), true);
                view.setUint16(2, parseInt(p[1]||0), true);
            }
        } catch(e) {}
        return Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2,'0')).join('').toUpperCase();
    }

    function updatePreview() {
        const nid = parseInt(document.getElementById('nodeIdSelect').value);
        const mid = parseInt(document.getElementById('cmdType').value);
        const valStr = document.getElementById('cmdValue').value;
        const canId = (nid << 6) | (mid & 0x3F);
        const payloadHex = constructPayload(mid, valStr);
        const fullCmd = `${canId.toString(16).toUpperCase().padStart(2, '0')} 0 ${payloadHex}`;
        document.getElementById('previewStr').innerText = fullCmd;
        return fullCmd;
    }

    async function sendRaw(str) {
        if (!port || !port.writable) return;
        const writer = port.writable.getWriter();
        await writer.write(new TextEncoder().encode(str + "\n"));
        writer.releaseLock();
    }

    function requestRtr(mid) {
        const nid = document.getElementById('nodeIdSelect').value;
        const canId = (parseInt(nid) << 6) | (parseInt(mid) & 0x3F);
        sendRaw(`${canId.toString(16).toUpperCase()} 1 0000000000000000`);
    }

    document.getElementById('sendBtn').addEventListener('click', () => sendRaw(updatePreview()));
    document.getElementById('refreshRtr').addEventListener('click', async () => {
        for (let mid in CAN_FORMATS) { if (CAN_FORMATS[mid][1]) { requestRtr(mid); await new Promise(r => setTimeout(r, 35)); } }
    });
    ['cmdType', 'cmdValue'].forEach(id => document.getElementById(id).addEventListener('input', updatePreview));
</script>
</body>
</html>
